<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive HTML BOM Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            min-height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', system-ui, sans-serif;
            background: #ffffff;
            color: #0a0a0a;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: min(1200px, 95vw);
            width: 100%;
            margin: 0 auto;
            padding: clamp(16px, 3vh, 32px) clamp(20px, 4vw, 48px);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: flex-start;
        }
        
        .header-section {
            flex-shrink: 0;
            margin-bottom: clamp(16px, 3vh, 32px);
        }
        
        h1 {
            font-size: clamp(24px, 4vw, 36px);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: clamp(2px, 0.5vh, 6px);
            color: #0a0a0a;
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: clamp(13px, 1.8vw, 16px);
            color: #6b7280;
            font-weight: 400;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            gap: clamp(12px, 2vh, 20px);
        }
        
        .server-note {
            margin-bottom: clamp(12px, 2vh, 20px);
            padding: clamp(12px, 2vh, 16px) clamp(16px, 2.5vw, 20px);
            background: #f8fafc;
            border-radius: 6px;
            font-size: clamp(13px, 1.6vw, 15px);
            color: #475569;
            border: 1px solid #e2e8f0;
            display: none;
            flex-shrink: 0;
            line-height: 1.6;
        }
        
        .server-note strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        .server-note code {
            background: #f1f5f9;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: clamp(12px, 1.4vw, 14px);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
            color: #0f172a;
            border: 1px solid #e2e8f0;
        }
        
        .upload-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            gap: clamp(12px, 2vh, 16px);
        }
        
        .upload-area {
            border: 1.5px dashed #d1d5db;
            border-radius: 6px;
            padding: clamp(24px, 5vh, 40px) clamp(20px, 4vw, 32px);
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }
        
        .upload-area:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }
        
        .upload-area.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .upload-icon {
            font-size: clamp(28px, 5vw, 40px);
            margin-bottom: clamp(8px, 1.5vh, 14px);
            opacity: 0.6;
        }
        
        .upload-text {
            font-size: clamp(14px, 2vw, 16px);
            font-weight: 500;
            color: #111827;
            margin-bottom: clamp(2px, 0.5vh, 6px);
        }
        
        .upload-hint {
            font-size: clamp(12px, 1.5vw, 14px);
            color: #6b7280;
        }
        
        #fileInput {
            display: none;
        }
        
        .button {
            width: 100%;
            padding: clamp(10px, 2vh, 14px) clamp(20px, 4vw, 28px);
            font-size: clamp(14px, 1.8vw, 16px);
            font-weight: 500;
            color: #ffffff;
            background: #0a0a0a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-family: inherit;
            flex-shrink: 0;
        }
        
        .button:hover:not(:disabled) {
            background: #1f1f1f;
        }
        
        .button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background: transparent;
            color: #0a0a0a;
            border: 1px solid #e5e7eb;
        }
        
        .button-secondary:hover:not(:disabled) {
            background: #fafafa;
            border-color: #d1d5db;
        }
        
        .file-info {
            padding: clamp(10px, 1.5vh, 14px) clamp(12px, 2vw, 18px);
            background: #f9fafb;
            border-radius: 6px;
            font-size: clamp(12px, 1.5vw, 14px);
            color: #374151;
            border: 1px solid #e5e7eb;
            display: none;
            flex-shrink: 0;
            line-height: 1.6;
        }
        
        .file-info strong {
            color: #111827;
            font-weight: 500;
        }
        
        .status {
            padding: clamp(12px, 2vh, 16px) clamp(16px, 2.5vw, 20px);
            border-radius: 6px;
            font-size: clamp(13px, 1.6vw, 15px);
            display: none;
            line-height: 1.6;
            flex-shrink: 0;
        }
        
        .status.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .status.info {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #7dd3fc;
        }
        
        .status.processing {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fcd34d;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #e5e7eb;
            border-top-color: #0a0a0a;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .actions-section {
            flex-shrink: 0;
            margin-top: clamp(12px, 2vh, 20px);
        }
        
        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: clamp(12px, 2vh, 16px) 0;
        }
        
        .footer {
            flex-shrink: 0;
            margin-top: clamp(12px, 2vh, 20px);
            padding-top: clamp(12px, 2vh, 16px);
            border-top: 1px solid #e5e7eb;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: clamp(16px, 3vw, 24px);
        }
        
        .footer-links a {
            font-size: clamp(12px, 1.5vw, 14px);
            color: #6b7280;
            text-decoration: none;
            transition: color 0.15s ease;
        }
        
        .footer-links a:hover {
            color: #111827;
        }
        
        /* Landscape orientation */
        @media (orientation: landscape) and (max-height: 600px) {
            .container {
                padding: clamp(12px, 2vh, 20px) clamp(20px, 4vw, 40px);
            }
            
            .header-section {
                margin-bottom: clamp(8px, 1.5vh, 16px);
            }
            
            .upload-area {
                padding: clamp(16px, 3vh, 24px) clamp(20px, 4vw, 28px);
            }
        }
        
        /* Portrait orientation */
        @media (orientation: portrait) and (max-width: 768px) {
            .container {
                padding: clamp(16px, 3vh, 24px) clamp(16px, 4vw, 24px);
            }
        }
        
        /* Ultra-wide screens */
        @media (min-width: 1920px) {
            .container {
                max-width: 1400px;
            }
        }
        
        /* Tall/narrow screens */
        @media (max-width: 480px) {
            .upload-area {
                padding: clamp(20px, 4vh, 28px) clamp(16px, 4vw, 20px);
            }
        }
        
        /* Very short screens */
        @media (max-height: 600px) {
            .main-content {
                gap: clamp(8px, 1vh, 12px);
            }
        }
        
        /* Square-ish screens */
        @media (min-aspect-ratio: 1/1) and (max-aspect-ratio: 16/10) {
            .container {
                padding: clamp(20px, 3vh, 28px) clamp(24px, 5vw, 40px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>Interactive HTML BOM</h1>
            <p class="subtitle">Generate interactive Bill of Materials from PCB files</p>
        </div>
        
        <div class="server-note" id="serverCheck">
            <strong>Server not running</strong><br>
            Start the web server by running <code>python3 run.py</code> or <code>python3 web/web_server.py</code>.
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ðŸ“„</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-hint">Supports .PcbDoc (Altium) and .kicad_pcb files</div>
                    <input type="file" id="fileInput" accept=".PcbDoc,.pcbdoc,.kicad_pcb">
                </div>
                
                <button class="button" id="processButton" disabled>Generate BOM</button>
                
                <div class="file-info" id="fileInfo"></div>
                <div class="status" id="status"></div>
            </div>
        </div>
        
        <div class="actions-section">
            <div class="divider"></div>
            <button class="button button-secondary" id="cleanupButton">Clean Up Temporary Files</button>
        </div>
        
        <footer class="footer">
            <div class="footer-links">
                <a href="https://cabhinav.com" target="_blank" rel="noopener noreferrer">
                    Website
                </a>
                <a href="https://github.com/abhinav937/InteractiveHtmlBom-w-altium" target="_blank" rel="noopener noreferrer">
                    GitHub
                </a>
            </div>
        </footer>
    </div>
    
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const statusDiv = document.getElementById('status');
        const fileInfo = document.getElementById('fileInfo');
        const cleanupButton = document.getElementById('cleanupButton');
        
        let selectedFile = null;
        
        fetch('/status')
            .then(response => {
                if (!response.ok) {
                    document.getElementById('serverCheck').style.display = 'block';
                }
            })
            .catch(() => {
                document.getElementById('serverCheck').style.display = 'block';
            });
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['pcbdoc', 'kicad_pcb'].includes(ext)) {
                showStatus(`Unsupported file type (.${ext}). Please select a .PcbDoc (Altium) or .kicad_pcb (KiCad) file.`, 'error');
                selectedFile = null;
                processButton.disabled = true;
                fileInfo.style.display = 'none';
                fileInput.value = '';
                return;
            }
            
            selectedFile = file;
            processButton.disabled = false;
            
            // Format file size
            let sizeDisplay;
            if (file.size < 1024) {
                sizeDisplay = file.size + ' bytes';
            } else if (file.size < 1024 * 1024) {
                sizeDisplay = (file.size / 1024).toFixed(2) + ' KB';
            } else {
                sizeDisplay = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            }
            
            // Format last modified date
            let lastModified = 'Unknown';
            if (file.lastModified) {
                const date = new Date(file.lastModified);
                lastModified = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            }
            
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${sizeDisplay}<br>
                <strong>Type:</strong> ${ext === 'pcbdoc' ? 'Altium Designer' : 'KiCad'} PCB<br>
                <strong>Modified:</strong> ${lastModified}
            `;
            
            showStatus('File ready. Click "Generate BOM" to continue.', 'info');
        }
        
        processButton.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            processButton.disabled = true;
            showStatus('<div class="spinner"></div>Processing file... This may take a moment.', 'processing');
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message + ' Opening in new tab...', 'success');
                    if (result.url) {
                        setTimeout(() => {
                            try {
                                const newWindow = window.open(result.url, '_blank');
                                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                                    showStatus(result.message + ' <a href="' + result.url + '" target="_blank" style="color: #166534; text-decoration: underline; font-weight: 500;">Click here to open the BOM</a>', 'success');
                                } else {
                                    showStatus(result.message, 'success');
                                }
                            } catch (e) {
                                showStatus(result.message + ' <a href="' + result.url + '" target="_blank" style="color: #166534; text-decoration: underline; font-weight: 500;">Click here to open the BOM</a>', 'success');
                            }
                        }, 100);
                    } else {
                        showStatus('BOM generated, but URL is unavailable.', 'error');
                    }
                } else {
                    showStatus(result.error || 'Unable to generate BOM. Please try again.', 'error');
                }
            } catch (error) {
                showStatus('Connection error. Please check your server connection.', 'error');
            } finally {
                processButton.disabled = false;
            }
        });
        
        cleanupButton.addEventListener('click', async () => {
            cleanupButton.disabled = true;
            showStatus('Cleaning up temporary files...', 'info');
            
            try {
                const response = await fetch('/cleanup', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Temporary files removed successfully.', 'success');
                } else {
                    showStatus('Unable to clean up files. Please try again.', 'error');
                }
            } catch (error) {
                showStatus('Connection error. Please check your server connection.', 'error');
            } finally {
                cleanupButton.disabled = false;
            }
        });
        
        function showStatus(message, type) {
            statusDiv.textContent = '';
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message;
        }
    </script>
</body>
</html>
